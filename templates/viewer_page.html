{% extends "base.html" %}
{% load static %}
{% block title %}Viewer{% endblock %}
{% block extra_head %}
<style>
   .bmc-preview-card {
      width: 180px;
      height: 220px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(7,91,94,0.10);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      border: 2px dashed #b5b5b5;
      color: #b5b5b5;
      font-size: 0.95rem;
      font-weight: 500;
      text-align: center;
      overflow: hidden;
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
   }
   .bmc-preview-card:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(7,91,94,0.20);
   }
   .bmc-preview-pdf {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
      display: block;
      border-radius: 16px;
   }
   .bmc-preview-placeholder {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b5b5b5;
      font-size: 0.95rem;
      font-weight: 500;
      background: #fff;
      border-radius: 16px;
      z-index: 1;
   }
   .pdf-viewer-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
   }
   .pdf-view-button {
      background: #075B5E;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      margin-top: 8px;
   }
   .pdf-view-button:hover {
      background: #0a7c80;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(7,91,94,0.20);
   }
   .aside-card {
      background: #C1DBB3;
      border-radius: 20px;
      width: 350px;
      padding: 32px 0;
      margin: 10px 0 10px 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      align-items: stretch;
   }
   .aside-item {
      background: #F2C078;
      border-radius: 12px;
      margin: 12px 24px;
      padding: 18px 24px;
      font-weight: 400;
      font-size: 1.1rem;
      color: #333;
      transition: transform 0.2s;
      cursor: pointer;
      text-align: left;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
   }
   .aside-item:hover {
      transform: scale(1.07);
      z-index: 1;
   }
   .dropdown-icon {
      margin-left: 10px;
      font-size: 1.1rem;
      transition: transform 0.2s;
   }
   .aside-subitems {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      flex-direction: column;
      margin-left: 36px;
      margin-right: 24px;
      margin-top: 4px;
      transition: opacity 0.3s, max-height 0.3s;
      display: flex;
      pointer-events: none;
   }
   .aside-subitem {
      background: #F2C078;
      border-radius: 10px;
      margin: 6px 0;
      padding: 12px 18px;
      font-size: 1rem;
      color: #444;
      font-weight: 400;
      cursor: pointer;
      transition: transform 0.2s;
   }
   .aside-subitem:hover {
      transform: scale(1.05);
      z-index: 1;
   }
   .aside-item.open .dropdown-icon {
      transform: rotate(90deg);
   }
   .aside-item.open + .aside-subitems {
      opacity: 1;
      max-height: 400px;
      pointer-events: auto;
   }
   /* Profile Card Styles */
   .profile-banner-card {
      background: #C1DBB3;
      border-radius: 20px;
      margin: 20px;
      width: calc(100% - 40px);
      box-sizing: border-box;
      display: flex;
      align-items: center;
      padding: 16px 24px;
      position: relative;
      min-height: 110px;
   }
   .profile-picture {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #096B68;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      margin: 0 18px 0 0;
      padding: 0;
      overflow: hidden;
      position: relative;
      align-self: center;
   }
   .profile-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 120px;
   }
   .profile-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #096B68;
      margin-bottom: 2px;
   }
   .profile-email {
      font-size: 0.95rem;
      color: #333;
      opacity: 0.8;
   }
   .agreements-stats {
      display: flex;
      gap: 18px;
      margin-left: auto;
      align-items: center;
   }
   .agreements-stat-card {
      background: #075B5E;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 18px 10px 18px;
      box-shadow: 0 2px 12px rgba(7,91,94,0.10);
      min-width: 110px;
      min-height: 70px;
      justify-content: center;
   }
   .agreements-stat-label {
      color: #fff;
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
      text-align: center;
      white-space: nowrap;
   }
   .agreements-stat-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #CAE8BD;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.8rem, 2vw, 1.1rem);
      font-weight: 700;
      color: #075B5E;
      box-shadow: 0 2px 8px rgba(242,192,120,0.13);
      margin: 0 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 90%;
      padding: 0 4px;
   }
   .agreements-stat-card.complete,
   .agreements-stat-card.incomplete,
   .agreements-stat-card.expired {
      transition: transform 0.18s cubic-bezier(.4,1.3,.6,1), box-shadow 0.18s;
      cursor: pointer;
   }
   .agreements-stat-card.complete:hover,
   .agreements-stat-card.incomplete:hover,
   .agreements-stat-card.expired:hover {
      transform: scale(1.07);
      z-index: 2;
   }
   .agreements-stat-card.selected {
      box-shadow: 0 0 0 3px #F2C078, 0 2px 12px rgba(7,91,94,0.10);
      background: #0a7c80 !important;
   }
   /* Updated form-card style for BMC AGREEMENT */
   .form-card.bmc-active, .form-card.amc-active, .form-card.input-service-active {
      background: #075B5E !important;
      color: #fff !important;
      margin: 10px 20px 10px 20px !important;
      border-radius: 18px;
      min-height: 100%;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      padding: 32px 24px;
      display: flex;
      font-size: 1.25rem;
      font-weight: 600;
      flex-direction: column;
   }
   .form-card {
      transition: background 0.2s, color 0.2s;
   }
   @media (max-width: 900px) {
      .profile-banner-card {
         flex-direction: column;
         height: auto;
         padding: 20px;
         align-items: flex-start;
      }
      .agreements-stats {
         margin-left: 0;
         margin-top: 16px;
         width: 100%;
         justify-content: flex-start;
      }
   }
   .bmc-result-outer-card, .amc-result-outer-card {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 2px 16px rgba(7,91,94,0.13);
      margin: 22px 0 0 0;
      padding: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: box-shadow 0.2s;
   }
   .bmc-result-row, .amc-result-row {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding: 22px 32px 12px 32px;
      border-radius: 22px 22px 0 0;
      background: #fff;
      font-size: 1.13rem;
      font-weight: 100;
      color: #000;
   }
   .bmc-result-row > div, .amc-result-row > div {
      flex: 1;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.5px;
   }
   .bmc-result-value, .amc-result-value {
      font-size: 1.1rem;
      color: #333;
      font-weight: 400;
      letter-spacing: 0.5px;
   }
   .bmc-result-inner-card, .amc-result-inner-card {
      background: #C1DBB3;
      border-radius: 18px;
      margin: 22px 22px 22px 22px;
      padding: 18px 24px 18px 24px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(7,91,94,0.10);
      font-size: 1.08rem;
      font-weight: 500;
      color: #075B5E;
   }
   .bmc-result-inner-card > div, .amc-result-inner-card > div {
      flex: 1;
      text-align: center;
   }
   .bmc-result-expire, .amc-result-expire {
      background: #fff;
      color: #d9534f;
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 1rem;
      font-weight: 600;
      margin-left: 10px;
      display: inline-block;
   }
   .bmc-missing-doc, .amc-missing-doc {
      background: #fff;
      color: #d9534f;
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 1rem;
      font-weight: 600;
      margin-left: 10px;
      display: inline-block;
   }
   .bmc-no-result, .amc-no-result {
      color: #fff;
      text-align: center;
      margin-top: 18px;
      font-size: 1.1rem;
   }
   .bmc-search-icon-btn, .amc-search-icon-btn {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%) rotate(-20deg);
      color: #2C2C2C;
      font-size: 1.2rem;
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 0;
      z-index: 2;
   }
   /* Style for the data fields to match aside items */
   .data-field-container {
      display: flex;
      font-weight: 700;
      gap: 0;
      border-bottom: 1px solid #c9a98b;
      padding: 12px 0 8px 0;
      background: #DEBA9D;
      border-radius: 18px 18px 0 0;
      color: #2C2C2C;
      font-size: 1.08rem;
      width: 100%;
   }
   .data-field {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-weight: 600;
   }
</style>
{% endblock %}
{% block content %}
<!-- Profile Banner Card -->
<div class="profile-banner-card">
   <div class="profile-picture">
      {% if user.profile_picture %}
      <img src="{{ user.profile_picture.url }}" alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
      {% else %}
      <span style="font-size:2rem; color:white;">
      {% if user.first_name %}
      {{ user.first_name|first|upper }}
      {% else %}
      U
      {% endif %}
      </span>
      {% endif %}
   </div>
   <div class="profile-info">
      <div class="profile-name">
         {% if user.first_name %}
         {{ user.first_name }} {{user.last_name}}
         {% else %}
         {{ user.username }}
         {% endif %}
      </div>
      <div class="profile-email">
         Employee I.D: {{ user.employee_code }}
      </div>
   </div>
   <div class="agreements-stats">
      <div class="agreements-stat-card">
         <span class="agreements-stat-label">Total Agreements</span>
         <span class="agreements-stat-circle">1424</span>
      </div>
      <div class="agreements-stat-card complete" id="complete-card">
         <span class="agreements-stat-label">Complete Agreements</span>
         <span class="agreements-stat-circle">12</span>
      </div>
      <div class="agreements-stat-card incomplete" id="incomplete-card">
         <span class="agreements-stat-label">Incomplete Agreements</span>
         <span class="agreements-stat-circle">8</span>
      </div>
      <div class="agreements-stat-card expired" id="expired-card">
         <span class="agreements-stat-label">Expired Agreements</span>
         <span class="agreements-stat-circle">4</span>
      </div>
   </div>
</div>
<!-- End Profile Banner Card -->
<div style="display: flex; justify-content: flex-start;">
   <aside class="aside-card">
      <div class="aside-item" id="amc-agreement">AMC AGREEMENT</div>
      <div class="aside-item" id="bmc-agreement">BMC AGREEMENT</div>
      <div class="aside-item" id="input-service-agreement">INPUT SERVICES AGREEMENT</div>
      <div class="aside-item">CONSULTANT AGREEMENT</div>
      <div class="aside-item">COOK AGREEMENT</div>
      <div class="aside-item">DISTRIBUTER AGREEMENT</div>
      <div class="aside-item">INWARD TRANSPORT AGREEMENT</div>
      <div class="aside-item">OUTWARD TRANSPORT AGREEMENT</div>
      <div class="aside-item">MILK SALE AGREEMENT</div>
      <div class="aside-item">MCC AGREEMENT</div>
      <div class="aside-item">MPACS AGREEMENT</div>
      <div class="aside-item">MPP/SAHAYAK AGREEMENT</div>
      <div class="aside-item">RTA AGREEMENT</div>
      <div class="aside-item" id="rental-toggle" onclick="toggleDropdown(this)">
         RENTAL AGREEMENT
         <span class="dropdown-icon"><i class="fa-solid fa-chevron-right"></i></span>
      </div>
      <div class="aside-subitems" id="rental-subitems">
         <div class="aside-subitem">GODOWN/STORE</div>
         <div class="aside-subitem">OFFICE LEASE</div>
         <div class="aside-subitem">GUEST HOUSE AGREEMENT</div>
      </div>
   </aside>
   <div class="form-card active" id="view-form" style="background: #075B5E; display: flex; align-items: center; justify-content: center; height: 450px; border-radius: 18px; margin: 10px 20px 10px 20px; flex: 1; flex-direction: column;">
      <span id="view-form-text" style="font-size:1.3rem; color:#fff; font-weight:500; text-align:center;">
      Please click on the Agreement you are willing to see
      </span>
      <!-- AMC SEARCH CONTAINER -->
      <div id="amc-search-container" style="display: none; width: 100%;">
         <div style="padding: 15px 20px 0 20px; margin-bottom: 10px; margin-top: 20px;">
            <div style="position: relative; width: 100%;">
               <input type="text" id="amc-location-search" placeholder="SEARCH BY CONTRACTOR, PRODUCT"
                  style="width: 100%; background: #FFEDDB; border: none; border-radius: 24px; padding: 12px 44px 12px 18px; font-size: 1rem; color: #000; outline: none; box-sizing: border-box; font-weight: 500;"
                  onkeydown="if(event.key==='Enter'){document.getElementById('amc-search-btn').click();}"
               />
               <button id="amc-search-btn" class="amc-search-icon-btn" tabindex="-1">
                  <i class="fas fa-search"></i>
               </button>
            </div>
            <div id="amc-search-result-container"></div>
         </div>
      </div>
      <!-- BMC SEARCH CONTAINER -->
      <div id="bmc-search-container" style="display:none; width:100%;">
         <div style="padding: 15px 20px 0 20px; margin-bottom: 10px; margin-top: 20px;">
            <div style="position: relative; width: 100%;">
               <input
                  id="bmc-location-search"
                  type="text"
                  placeholder="SEARCH BY LOCATION"
                  style="
                  width: 100%;
                  background: #FFEDDB;
                  border: none;
                  border-radius: 24px;
                  padding: 12px 44px 12px 18px;
                  font-size: 1rem;
                  color: #000;
                  outline: none;
                  box-sizing: border-box;
                  font-weight: 500;
                  "
                  onkeydown="if(event.key==='Enter'){document.getElementById('bmc-search-btn').click();}"
                  />
               <button id="bmc-search-btn" class="bmc-search-icon-btn" tabindex="-1">
               <i class="fas fa-search"></i>
               </button>
            </div>
            <div id="bmc-search-result-container"></div>
         </div>
      </div>
      <!-- INPUT SERVICES SEARCH CONTAINER -->
      <div id="input-service-search-container" style="display: none; width: 100%;">
         <div style="padding: 15px 20px 0 20px; margin-bottom: 10px; margin-top: 20px;">
            <div style="position: relative; width: 100%;">
               <input type="text" id="input-service-product-search" placeholder="SEARCH BY CONTRACTOR, PRODUCT"
                  style="width: 100%; background: #FFEDDB; border: none; border-radius: 24px; padding: 12px 44px 12px 18px; font-size: 1rem; color: #000; outline: none; box-sizing: border-box; font-weight: 500;"
                  onkeydown="if(event.key==='Enter'){document.getElementById('input-service-search-btn').click();}"
               />
               <button id="input-service-search-btn" class="bmc-search-icon-btn" tabindex="-1">
                  <i class="fas fa-search"></i>
               </button>
            </div>
            <div id="input-service-search-result-container"></div>
         </div>
      </div>
   </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function toggleDropdown(element) {
    element.classList.toggle('open');
}

function daysUntil(dateStr) {
    const today = new Date();
    const end = new Date(dateStr);
    const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
    return diff;
}

function formatDateDMY(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = String(d.getFullYear()).slice(-2);
    return `${day}/${month}/${year}`;
}

document.addEventListener('DOMContentLoaded', function() {
    const selectable = [
        document.getElementById('complete-card'),
        document.getElementById('incomplete-card'),
        document.getElementById('expired-card')
    ];
    let selectedStatus = null;

    function resetBmcSearchResults() {
        document.getElementById('bmc-location-search').value = '';
        document.getElementById('bmc-search-result-container').innerHTML = '';
    }
    
    function resetAmcSearchResults() {
        document.getElementById('amc-location-search').value = '';
        document.getElementById('amc-search-result-container').innerHTML = '';
    }
    
    function resetInputServiceSearchResults() {
        document.getElementById('input-service-product-search').value = '';
        document.getElementById('input-service-search-result-container').innerHTML = '';
    }

    selectable.forEach(card => {
        card.addEventListener('click', function() {
            selectable.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedStatus = this.querySelector('.agreements-stat-label').textContent.trim().split(' ')[0].toUpperCase();

            // If AMC AGREEMENT is active, rerender the card and reset results
            const amcSearch = document.getElementById('amc-search-container');
            const bmcSearch = document.getElementById('bmc-search-container');
            const inputServiceSearch = document.getElementById('input-service-search-container');
            const viewForm = document.getElementById('view-form');
            const viewFormText = document.getElementById('view-form-text');
            
            if (viewForm.classList.contains('amc-active')) {
                if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
                    viewFormText.textContent = `AMC AGREEMENTS (STATUS = ${selectedStatus})`;
                    amcSearch.style.display = "block";
                } else {
                    viewForm.classList.remove('amc-active');
                    viewFormText.textContent = 'Please click on the Agreement you are willing to see';
                    amcSearch.style.display = "none";
                }
                resetAmcSearchResults();
            }
            
            if (viewForm.classList.contains('bmc-active')) {
                if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
                    viewFormText.textContent = `BMC AGREEMENTS (STATUS = ${selectedStatus})`;
                    bmcSearch.style.display = "block";
                } else {
                    viewForm.classList.remove('bmc-active');
                    viewFormText.textContent = 'Please click on the Agreement you are willing to see';
                    bmcSearch.style.display = "none";
                }
                resetBmcSearchResults();
            }
            
            if (viewForm.classList.contains('input-service-active')) {
                if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
                    viewFormText.textContent = `INPUT SERVICES AGREEMENTS (STATUS = ${selectedStatus})`;
                    inputServiceSearch.style.display = "block";
                } else {
                    viewForm.classList.remove('input-service-active');
                    viewFormText.textContent = 'Please click on the Agreement you are willing to see';
                    inputServiceSearch.style.display = "none";
                }
                resetInputServiceSearchResults();
            }
        });
    });

    document.getElementById('amc-agreement').addEventListener('click', function() {
        const viewForm = document.getElementById('view-form');
        const viewFormText = document.getElementById('view-form-text');
        const amcSearch = document.getElementById('amc-search-container');
        const bmcSearch = document.getElementById('bmc-search-container');
        const inputServiceSearch = document.getElementById('input-service-search-container');
        
        // Hide other search containers
        bmcSearch.style.display = "none";
        inputServiceSearch.style.display = "none";
        viewForm.classList.remove('bmc-active');
        viewForm.classList.remove('input-service-active');
        
        // Show AMC if status is selected
        if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
            viewForm.classList.add('amc-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = `AMC AGREEMENTS (STATUS = ${selectedStatus})`;
            amcSearch.style.display = "block";
        } else {
            viewForm.classList.remove('amc-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = 'Please click on the Agreement you are willing to see';
            amcSearch.style.display = "none";
        }
        
        // Reset AMC search input/results
        resetAmcSearchResults();
    });

    document.getElementById('bmc-agreement').addEventListener('click', function() {
        const viewForm = document.getElementById('view-form');
        const viewFormText = document.getElementById('view-form-text');
        const bmcSearch = document.getElementById('bmc-search-container');
        const inputServiceSearch = document.getElementById('input-service-search-container');
        const amcSearch = document.getElementById('amc-search-container');
        
        // Hide other search containers
        amcSearch.style.display = "none";
        inputServiceSearch.style.display = "none";
        viewForm.classList.remove('amc-active');
        viewForm.classList.remove('input-service-active');
        
        if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
            viewForm.classList.add('bmc-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = `BMC AGREEMENTS (STATUS = ${selectedStatus})`;
            bmcSearch.style.display = "block";
        } else {
            viewForm.classList.remove('bmc-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = 'Please click on the Agreement you are willing to see';
            bmcSearch.style.display = "none";
        }
        resetBmcSearchResults();
    });

    document.getElementById('input-service-agreement').addEventListener('click', function() {
        const viewForm = document.getElementById('view-form');
        const viewFormText = document.getElementById('view-form-text');
        const inputServiceSearch = document.getElementById('input-service-search-container');
        const bmcSearch = document.getElementById('bmc-search-container');
        const amcSearch = document.getElementById('amc-search-container');
        
        // Hide other search containers
        amcSearch.style.display = "none";
        bmcSearch.style.display = "none";
        viewForm.classList.remove('amc-active');
        viewForm.classList.remove('bmc-active');
        
        if (selectedStatus === 'COMPLETE' || selectedStatus === 'INCOMPLETE') {
            viewForm.classList.add('input-service-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = `INPUT SERVICES AGREEMENTS (STATUS = ${selectedStatus})`;
            inputServiceSearch.style.display = "block";
        } else {
            viewForm.classList.remove('input-service-active');
            viewFormText.style.color = '#fff';
            viewFormText.textContent = 'Please click on the Agreement you are willing to see';
            inputServiceSearch.style.display = "none";
        }
        resetInputServiceSearchResults();
    });

    document.getElementById('bmc-search-btn').addEventListener('click', function() {
        const input = document.getElementById('bmc-location-search');
        const query = input.value.trim();
        const status = selectedStatus ? selectedStatus : '';
        const resultDiv = document.getElementById('bmc-search-result-container');
        resultDiv.innerHTML = '';
        
        if (query.length === 0) {
            resultDiv.innerHTML = '<div class="bmc-no-result">Please enter a location.</div>';
            return;
        }

        fetch(`/bmc/search/viewer/?location=${encodeURIComponent(query)}&status=${encodeURIComponent(status)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(item => {
                        // Create a unique ID for each PDF container
                        const pdfContainerId = `pdf-container-${item.id}`;
                        
                        // Check if status is incomplete to show missing document message
                        const missingDocMessage = (item.document_status && item.document_status.toUpperCase() === 'INCOMPLETE') 
                            ? `<div style="padding:10px 0;width:100%;text-align:left;">
                                  <span>MISSING DOCUMENT:<span class="bmc-missing-doc">${item.pending_document}</span></span>
                               </div>`
                            : '';
                        
                        html += `
<div class="bmc-result-outer-card" style="background:#fff;">
    <div class="data-field-container">
        <div class="data-field">ZONE</div>
        <div class="data-field">LOCATION</div>
        <div class="data-field">CONTRACTOR</div>
        <div class="data-field">DOCUMENT STATUS</div>
    </div>
    <div class="bmc-result-row" style="background:#fff; border-radius:0; padding:18px 0 0 0; font-size:1.1rem">
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.zone || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.location || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.contractor || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.document_status || '-'}</div>
    </div>
    <div class="bmc-result-inner-card" style="display:flex;flex-direction:row;align-items:center;gap:2px;">
        <div style="flex:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;height:220px;padding-left:10px;">
            ${missingDocMessage}
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement Start Date: ${formatDateDMY(item.start_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement End Date: ${formatDateDMY(item.end_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Expire in: <span class="bmc-result-expire">${item.expire_months !== undefined ? item.expire_months : '-'} month${item.expire_months == 1 ? '' : 's'} from today</span></span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Scanned & Inserted By: <span class="bmc-result-expire" style="color:#d9534f;">${item.created_by}</span></span>
            </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="bmc-preview-card" style="width:180px;height:220px;">
                ${item.document_url ? `
                <div id="${pdfContainerId}" class="pdf-viewer-container" style="width:100%;height:100%;">
                    <iframe class="bmc-preview-pdf" src="${item.document_url}#toolbar=0&navpanes=0&scrollbar=0" style="width:100%;height:100%;border:none;"></iframe>
                </div>
                ` : `
                <div class="bmc-preview-placeholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">NO PDF</div>
                `}
            </div>
            ${item.document_url ? `
            <a href="${item.document_url}" target="_blank" class="pdf-view-button">VIEW IN FULL PAGE</a>
            ` : ''}
        </div>
    </div>
</div>
                        `;
                    });
                    resultDiv.innerHTML = html;

                    // Add fallback for PDFs that can't be embedded
                    document.querySelectorAll('.bmc-preview-pdf').forEach(iframe => {
                        iframe.onload = function() {
                            try {
                                // Check if we can access the iframe content
                                if (iframe.contentDocument || iframe.contentWindow.document) {
                                    // PDF loaded successfully
                                }
                            } catch (e) {
                                // If we get a security error, show a link instead
                                const container = iframe.parentElement;
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 20px; width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                                        <p>PDF cannot be previewed</p>
                                        <a href="${iframe.src}" target="_blank" class="pdf-view-button">
                                            VIEW PDF IN NEW TAB
                                        </a>
                                    </div>
                                `;
                            }
                        };
                    });
                } else {
                    resultDiv.innerHTML = '<div class="bmc-no-result">No results found.</div>';
                }
            })
            .catch(() => {
                resultDiv.innerHTML = '<div class="bmc-no-result">Error fetching results.</div>';
            });
    });

    document.getElementById('amc-search-btn').addEventListener('click', function() {
        const input = document.getElementById('amc-location-search');
        const query = input.value.trim();
        const status = selectedStatus ? selectedStatus : '';
        const resultDiv = document.getElementById('amc-search-result-container');
        resultDiv.innerHTML = '';
        
        if (query.length === 0) {
            resultDiv.innerHTML = '<div class="amc-no-result">Please enter contractor or product.</div>';
            return;
        }

        // Split query by comma for contractor and product
        let contractor = '';
        let product = '';
        const parts = query.split(',');
        if (parts.length > 0) contractor = parts[0].trim();
        if (parts.length > 1) product = parts.slice(1).join(',').trim();

        const params = new URLSearchParams();
        if (contractor) params.append('contractor', contractor);
        if (product) params.append('product', product);
        if (status) params.append('status', status);

        fetch(`/amc/search/viewer/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(item => {
                        const pdfContainerId = `pdf-container-amc-${item.id}`;
                        const missingDocMessage = (item.document_status && item.document_status.toUpperCase() === 'INCOMPLETE') 
                            ? `<div style="padding:10px 0;width:100%;text-align:left;">
                                  <span>MISSING DOCUMENT:<span class="amc-missing-doc">${item.pending_document}</span></span>
                               </div>`
                            : '';
                        html += `
<div class="amc-result-outer-card" style="background:#fff;">
    <div class="data-field-container">
        <div class="data-field">AGREEMENT DATE</div>
        <div class="data-field">PRODUCT</div>
        <div class="data-field">CONTRACTOR</div>
        <div class="data-field">DOCUMENT STATUS</div>
    </div>
    <div class="amc-result-row" style="background:#fff; border-radius:0; padding:18px 0 0 0; font-size:1.1rem">
        <div class="amc-result-value" style="flex:1;text-align:center;">${item.agreement_date || '-'}</div>
        <div class="amc-result-value" style="flex:1;text-align:center;">${item.product || '-'}</div>
        <div class="amc-result-value" style="flex:1;text-align:center;">${item.contractor || '-'}</div>
        <div class="amc-result-value" style="flex:1;text-align:center;">${item.document_status || '-'}</div>
    </div>
    <div class="amc-result-inner-card" style="display:flex;flex-direction:row;align-items:center;gap:2px;">
        <div style="flex:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;height:220px;padding-left:10px;">
            ${missingDocMessage}
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement Start Date: ${formatDateDMY(item.start_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement End Date: ${formatDateDMY(item.end_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Expire in: <span class="amc-result-expire">${item.expire_months !== undefined ? item.expire_months : '-'} month${item.expire_months == 1 ? '' : 's'} from today</span></span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Scanned & Inserted By: <span class="amc-result-expire" style="color:#d9534f;">${item.created_by}</span></span>
            </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="bmc-preview-card" style="width:180px;height:220px;">
                ${item.document_url ? `
                <div id="${pdfContainerId}" class="pdf-viewer-container" style="width:100%;height:100%;">
                    <iframe class="bmc-preview-pdf" src="${item.document_url}#toolbar=0&navpanes=0&scrollbar=0" style="width:100%;height:100%;border:none;"></iframe>
                </div>
                ` : `
                <div class="bmc-preview-placeholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">NO PDF</div>
                `}
            </div>
            ${item.document_url ? `
            <a href="${item.document_url}" target="_blank" class="pdf-view-button">VIEW IN FULL PAGE</a>
            ` : ''}
        </div>
    </div>
</div>
                        `;
                    });
                    resultDiv.innerHTML = html;

                    // Add fallback for PDFs that can't be embedded
                    document.querySelectorAll('.bmc-preview-pdf').forEach(iframe => {
                        iframe.onload = function() {
                            try {
                                if (iframe.contentDocument || iframe.contentWindow.document) {
                                    // PDF loaded successfully
                                }
                            } catch (e) {
                                const container = iframe.parentElement;
                                container.innerHTML = `
                                    <div style="text-align: center; padding: 20px; width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                                        <p>PDF cannot be previewed</p>
                                        <a href="${iframe.src}" target="_blank" class="pdf-view-button">
                                            VIEW PDF IN NEW TAB
                                        </a>
                                    </div>
                                `;
                            }
                        };
                    });
                } else {
                    resultDiv.innerHTML = '<div class="amc-no-result">No results found.</div>';
                }
            })
            .catch(() => {
                resultDiv.innerHTML = '<div class="amc-no-result">Error fetching results.</div>';
            });
    });

    document.getElementById('input-service-search-btn').addEventListener('click', function() {
    const input = document.getElementById('input-service-product-search');
    console.log("The input is", input)
    const query = input.value.trim();
    console.log("The query is", query)
    const status = selectedStatus ? selectedStatus : '';
    console.log("The status is", status)
    const resultDiv = document.getElementById('input-service-search-result-container');
    resultDiv.innerHTML = '';

    if (!query) {
        resultDiv.innerHTML = '<div class="bmc-no-result">Please enter a product.</div>';
        return;
    }
    const params = new URLSearchParams();
    let contractor = '';
    let product = '';
    const parts = query.split(',');
    if (parts.length > 0) contractor = parts[0].trim();
    if (parts.length > 1) product = parts.slice(1).join(',').trim();

    if (contractor) params.append('contractor', contractor);
    if (product) params.append('product', product);
    if (status) params.append('status', status);

    fetch(`/input-service/search/viewer/?${params.toString()}`)
        .then(response => {
            console.log(response)
            return response.json()})
        .then(data => {
            // Pretty print the response data in the console
            console.log('%c[INPUT SERVICES SEARCH] Response:', 'color: #0a7c80; font-weight: bold;', data);

            if (data.results && data.results.length > 0) {
                let html = '';
                data.results.forEach(item => {
                    const pdfContainerId = `pdf-container-input-service-${item.id}`;
                    const missingDocMessage = (item.document_status && item.document_status.toUpperCase() === 'INCOMPLETE') 
                        ? `<div style="padding:10px 0;width:100%;text-align:left;">
                              <span>MISSING DOCUMENT:<span class="bmc-missing-doc">${item.pending_document}</span></span>
                           </div>`
                        : '';
                    html += `
<div class="bmc-result-outer-card" style="background:#fff;">
    <div class="data-field-container">
        <div class="data-field">AGREEMENT DATE</div>
        <div class="data-field">PRODUCT</div>
        <div class="data-field">CONTRACTOR</div>
        <div class="data-field">DOCUMENT STATUS</div>
    </div>
    <div class="bmc-result-row" style="background:#fff; border-radius:0; padding:18px 0 0 0; font-size:1.1rem">
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.agreement_date || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.product || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.contractor || '-'}</div>
        <div class="bmc-result-value" style="flex:1;text-align:center;">${item.document_status || '-'}</div>
    </div>
    <div class="bmc-result-inner-card" style="display:flex;flex-direction:row;align-items:center;gap:2px;">
        <div style="flex:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;height:220px;padding-left:10px;">
            ${missingDocMessage}
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement Start Date: ${formatDateDMY(item.start_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Agreement End Date: ${formatDateDMY(item.end_date)}</span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Expire in: <span class="bmc-result-expire">${item.expire_months !== undefined ? item.expire_months : '-'} month${item.expire_months == 1 ? '' : 's'} from today</span></span>
            </div>
            <div style="padding:10px 0;width:100%;text-align:left;">
                <span>Scanned & Inserted By: <span class="bmc-result-expire" style="color:#d9534f;">${item.created_by}</span></span>
            </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="bmc-preview-card" style="width:180px;height:220px;">
                ${item.document_url ? `
                <div id="${pdfContainerId}" class="pdf-viewer-container" style="width:100%;height:100%;">
                    <iframe class="bmc-preview-pdf" src="${item.document_url}#toolbar=0&navpanes=0&scrollbar=0" style="width:100%;height:100%;border:none;"></iframe>
                </div>
                ` : `
                <div class="bmc-preview-placeholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">NO PDF</div>
                `}
            </div>
            ${item.document_url ? `
            <a href="${item.document_url}" target="_blank" class="pdf-view-button">VIEW IN FULL PAGE</a>
            ` : ''}
        </div>
    </div>
</div>
                    `;
                });
                resultDiv.innerHTML = html;

                // Add fallback for PDFs that can't be embedded
                document.querySelectorAll('.bmc-preview-pdf').forEach(iframe => {
                    iframe.onload = function() {
                        try {
                            if (iframe.contentDocument || iframe.contentWindow.document) {
                                // PDF loaded successfully
                            }
                        } catch (e) {
                            const container = iframe.parentElement;
                            container.innerHTML = `
                                <div style="text-align: center; padding: 20px; width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                                    <p>PDF cannot be previewed</p>
                                    <a href="${iframe.src}" target="_blank" class="pdf-view-button">
                                        VIEW PDF IN NEW TAB
                                    </a>
                                </div>
                            `;
                        }
                    };
                });
            } else {
                resultDiv.innerHTML = '<div class="bmc-no-result">No results found.</div>';
            }
        })
        .catch((error) => {
            console.error('[INPUT SERVICES SEARCH] Fetch error:', error);
            resultDiv.innerHTML = '<div class="bmc-no-result">Error fetching results.</div>';
        });
});
});
</script>
{% endblock %}